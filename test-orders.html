<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Test Orders Table</title>
  <style>
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
      cursor: pointer;
    }
    th:hover {
      background-color: #ddd;
    }
    button {
      margin: 5px;
      padding: 5px 10px;
    }
    #output {
      margin-top: 10px;
      padding: 10px;
      border: 1px solid #ddd;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <h1>Test Orders Table</h1>
  <div>
    <button id="fetch-shopify">Fetch Shopify Orders</button>
    <button id="load-sample">Load Sample Orders</button>
    <button id="clear-orders">Clear Orders</button>
  </div>
  <div id="output">Status messages will appear here...</div>
  <div id="orders-table-section"></div>

  <script type="module">
    import { saveOrders, loadOrders } from './storage.js';
    import { renderTable } from './table.js';

    let ORDERS = loadOrders();
    console.log('Initial ORDERS on page load:', ORDERS);
    let sortOrder = {};

    function showOrders(list) {
      const container = document.getElementById('orders-table-section');
      if (!container) {
        console.error('Container #orders-table-section not found');
        return;
      }

      if (!list || !list.length || !list[0] || typeof list[0] !== 'object') {
        container.innerHTML = "<p style='color:#b87;'>No valid orders loaded. Try fetching Shopify orders or loading sample orders.</p>";
        return;
      }

      const headers = Object.keys(list[0]);
      console.log('Table headers:', headers);
      const rows = list.map(o => headers.map(h => o[h]));

      renderTable({
        containerId: 'orders-table-section',
        headers,
        rows,
        options: { sortState: null }
      });

      console.log('Rendered table HTML:', container.innerHTML);

      setTimeout(() => {
        headers.forEach((h, idx) => {
          const thElement = document.querySelector(`#orders-table-section th[data-col='${idx}']`);
          if (thElement) {
            thElement.onclick = () => sortTable(idx, headers);
          } else {
            console.warn(`Table header for data-col='${idx}' not found in #orders-table-section`);
          }
        });
      }, 100);
    }

    function sortTable(idx, headers) {
      const col = headers[idx];
      sortOrder[col] = !sortOrder[col];
      ORDERS.sort((a, b) => {
        const A = (a[col] || '').toString().toLowerCase();
        const B = (b[col] || '').toString().toLowerCase();
        if (!isNaN(Date.parse(A)) && !isNaN(Date.parse(B)))
          return sortOrder[col] ? new Date(A) - new Date(B) : new Date(B) - new Date(A);
        if (!isNaN(+A) && !isNaN(+B))
          return sortOrder[col] ? +A - +B : +B - +A;
        return sortOrder[col] ? A.localeCompare(B) : B.localeCompare(A);
      });
      showOrders(ORDERS);
    }

    // Fetch orders from Shopify
    document.getElementById('fetch-shopify').onclick = async () => {
      const output = document.getElementById('output');
      output.textContent = 'Fetching Shopify orders...';

      try {
        const response = await fetch('/.netlify/functions/shopify-proxy');
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`Netlify Function error: ${response.status} ${response.statusText} - ${errorText}`);
        }
        const data = await response.json();
        output.textContent = 'Successfully fetched Shopify orders.';
        saveOrders(data);
        ORDERS = loadOrders();
        console.log('Fetched Shopify orders:', ORDERS);
        showOrders(ORDERS);
      } catch (error) {
        output.textContent = `Error: ${error.message}`;
        console.error('Error fetching Shopify orders:', error);
      }
    };

    // Load sample orders for testing
    document.getElementById('load-sample').onclick = () => {
      const output = document.getElementById('output');
      output.textContent = 'Loading sample orders...';
      const sampleOrders = [
        {
          'First Name': 'John',
          'Last Name': 'Doe',
          'Email': 'john.doe@example.com',
          'Role': 'Leader',
          'Classes': 'Level 1',
          'Paid': true,
          'order_id': '123',
          'order_date': '2024-01-01',
          'customer_id': '456',
          'product_title': 'Level 1 Course',
          'variant_title': 'Leader',
          'financial_status': 'paid',
          'Notes': ''
        }
      ];
      saveOrders(sampleOrders);
      ORDERS = loadOrders();
      console.log('Loaded sample orders:', ORDERS);
      output.textContent = 'Sample orders loaded.';
      showOrders(ORDERS);
    };

    // Clear orders for testing
    document.getElementById('clear-orders').onclick = () => {
      const output = document.getElementById('output');
      output.textContent = 'Clearing orders...';
      localStorage.removeItem('locomojo_orders');
      ORDERS = loadOrders();
      console.log('Cleared orders:', ORDERS);
      output.textContent = 'Orders cleared.';
      showOrders(ORDERS);
    };

    // Initial render
    showOrders(ORDERS);
  </script>
</body>
</html>